<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream de Torrent WebTorrent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.8.1/video-js.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.8.1/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 2rem;
        }
        .container {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 800px;
        }
        .video-js {
            width: 100%;
            height: auto;
            position: relative;
        }
        .log-container {
            margin-top: 1.5rem;
            background-color: #1a202c;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #video-container {
            position: relative;
        }
        #status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(45, 55, 72, 0.9);
            z-index: 10;
            transition: opacity 0.5s ease-in-out;
            font-size: 1.25rem;
            font-weight: 500;
        }
        .vjs-poster {
            z-index: 5 !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

<div class="container mx-auto">
    <h1 class="text-4xl font-bold mb-6 text-indigo-400">Streaming de Torrent</h1>
    <p class="text-gray-400 mb-8">Insira um link magnet para iniciar a reprodução imediata do vídeo.</p>

    <!-- Formulário para o link magnet -->
    <form class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-8">
        <input name="torrentId" id="magnet-link" type="text" placeholder="Cole seu magnet link aqui..."
               class="flex-grow p-3 rounded-md bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
               value="magnet:?xt=urn:btih:08ada5a7a6183aae1e09d831df6748d566095a10&dn=Sintel&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&ws=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2F&xs=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2Fsintel.torrent">
        <button type="submit" class="bg-indigo-600 text-white p-3 rounded-md font-semibold hover:bg-indigo-700 transition duration-300">
            Download
        </button>
    </form>

    <!-- Contêiner principal para o player e a mensagem de status -->
    <div class="relative w-full overflow-hidden rounded-md shadow-lg" id="player-wrapper">
        <video id="video-player" class="video-js vjs-theme-forest vjs-big-play-centered" controls="true"></video>
        <div id="status-overlay" class="p-4 text-center text-lg font-medium">Aguardando link magnet...</div>
    </div>
    
    <!-- Log de informações -->
    <div class="log-container hidden" id="log-display">
        <h2 class="text-2xl font-bold mb-2 text-indigo-300">Log</h2>
        <div class="log"></div>
    </div>
</div>

<script>
    // Função para inicializar a lista de trackers
    function initializeTrackers() {
        return [
            'udp://tracker.coppersurfer.tk:6969/announce',
            'udp://9.rarbg.com:2710/announce',
            'udp://1c.premierzal.ru:6969/announce',
            'udp://6ahddutb1ucc3cp.ru:6969/announce',
            'udp://bandito.byterunner.io:6969/announce',
            'udp://bt.bontal.net:6969/announce',
            'udp://d40969.acod.regrucolo.ru:6969/announce',
            'udp://evan.im:6969/announce',
            'udp://exodus.desync.com:6969',
            'udp://extracker.dahrkael.net:6969/announce',
            'udp://ipv4.tracker.harry.lu:80/announce',
            'udp://martin-gebhardt.eu:25/announce',
            'udp://open.demonii.com:1337/announce',
            'udp://open.stealth.si:80/announce',
            'udp://opentracker.io:6969/announce',
            'udp://p4p.arenabg.com:1337/announce',
            'udp://retracker.hotplug.ru:2710/announce',
            'udp://retracker.lanta.me:2710/announce',
            'udp://retracker01-msk-virt.corbina.net:80/announce',
            'udp://tr4ck3r.duckdns.org:6969/announce',
            'udp://tracker-de-2.cutie.dating:1337/announce',
            'udp://tracker.bitcoinindia.space:6969/announce',
            'udp://tracker.cloudbase.store:1333/announce',
            'udp://tracker.coppersurfer.tk:6969/announce',
            'udp://tracker.cyberia.is:6969/announce',
            'udp://tracker.dler.com:6969/announce',
            'udp://tracker.dler.org:6969/announce',
            'udp://tracker.ducks.party:1984/announce',
            'udp://tracker.fnix.net:6969/announce',
            'udp://tracker.gigantino.net:6969/announce',
            'udp://tracker.hifitechindia.com:6969/announce',
            'udp://tracker.openbittorrent.com:6969/announce',
            'udp://tracker.opentrackr.org:1337',
            'udp://tracker.opentrackr.org:1337/announce',
            'udp://tracker.plx.im:6969/announce',
            'udp://tracker.rescuecrew7.com:1337/announce',
            'udp://tracker.skillindia.site:6969/announce',
            'udp://tracker.srv00.com:6969/announce',
            'udp://tracker.startwork.cv:1337/announce',
            'udp://tracker.therarbg.to:6969/announce',
            'udp://tracker.tiny-vps.com:6969/announce',
            'udp://tracker.torrent.eu.org:451/announce',
            'udp://tracker.tryhackx.org:6969/announce',
            'udp://tracker.tvunderground.org.ru:3218/announce',
            'udp://tracker.valete.tf:9999/announce',
            'udp://tracker.zupix.online:1333/announce',
            'udp://ttk2.nbaonlineservice.com:6969/announce',
            'udp://www.torrent.eu.org:451/announce',
            'http://0123456789nonexistent.com:80/announce',
            'http://bt.okmp3.ru:2710/announce',
            'http://bt1.archive.org:6969/announce',
            'http://bt2.archive.org:6969/announce',
            'http://ipv4.rer.lol:2710/announce',
            'http://ipv6.rer.lol:6969/announce',
            'http://lucke.fenesisu.moe:6969/announce',
            'http://open.trackerlist.xyz:80/announce',
            'http://p4p.arenabg.com:1337/announce',
            'http://shubt.net:2710/announce',
            'http://torrent.hificode.in:6969/announce',
            'http://tracker.beeimg.com:6969/announce',
            'http://tracker.bt4g.com:2095/announce',
            'http://tracker.ipv6tracker.ru:80/announce',
            'http://tracker.mywaifu.best:6969/announce',
            'http://tracker.renfei.net:8080/announce',
            'https://1.tracker.eu.org:443/announce',
            'https://2.tracker.eu.org:443/announce',
            'https://3.tracker.eu.org:443/announce',
            'https://4.tracker.eu.org:443/announce',
            'https://opentracker.i2p.rocks:443/announce',
            'https://torrent.tracker.durukanbal.com:443/announce',
            'https://tr.nyacat.pw:443/announce',
            'https://tracker.alaskantf.com:443/announce',
            'https://tracker.expli.top:443/announce',
            'https://tracker.jdx3.org:443/announce',
            'https://tracker.moeblog.cn:443/announce',
            'https://tracker.yemekyedim.com:443/announce',
            'https://tracker.zhuqiy.top:443/announce',
            'wss://tracker.btorrent.xyz',
            'wss://tracker.fastcast.nz',
            'wss://tracker.openwebtorrent.com'
        ];
    }

    console.log('Iniciando o script da aplicação...');
    const client = new WebTorrent();
    const videoPlayerElement = document.getElementById('video-player');
    const statusOverlay = document.getElementById('status-overlay');
    const logDisplay = document.getElementById('log-display');

    console.log('Cliente WebTorrent criado.');

    client.on('error', function (err) {
        console.error('ERRO WebTorrent:', err);
        log('ERROR: ' + err.message);
        statusOverlay.innerHTML = `Erro: ${err.message}`;
    });

    document.querySelector('form').addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Formulário submetido. Iniciando processo...');

        let torrentId = document.querySelector('form input[name=torrentId]').value;
        if (!torrentId) {
            statusOverlay.innerHTML = 'Por favor, insira um link magnet válido.';
            console.warn('Erro de validação: O campo do magnet link está vazio.');
            return;
        }

        // Adiciona trackers ao magnet link se não houver trackers
        if (torrentId.startsWith('magnet:?')) {
            const trackers = initializeTrackers();
            let hasTrackers = /(&tr=|&ws=|&xs=)/.test(torrentId);
            if (!hasTrackers) {
                trackers.forEach(tr => {
                    torrentId += `&tr=${encodeURIComponent(tr)}`;
                });
            }
        }

        logDisplay.classList.remove('hidden');
        statusOverlay.innerHTML = 'Conectando-se aos pares e obtendo metadados...';
        log('Adicionando torrent: ' + torrentId);
        client.add(torrentId, onTorrent);
        console.log('Chamando client.add() com o torrentId.');
    });

    function onTorrent(torrent) {
        console.log('Evento "onTorrent" disparado. Metadados obtidos!');
        log('Metadados do torrent obtidos!');
        log('Hash do torrent: ' + torrent.infoHash);
        
        const videoFile = torrent.files.find(file => file.name.endsWith('.mp4') || file.name.endsWith('.webm'));
        console.log('Buscando arquivo de vídeo compatível...');

        if (videoFile) {
            log('Arquivo de vídeo encontrado: ' + videoFile.name);
            // Garante que o nome do arquivo termine com .mp4
            let fileName = videoFile.name;
            if (!fileName.toLowerCase().endsWith('.mp4')) {
                fileName += '.mp4';
            }
            // Extrai o diretório do arquivo
            let filePath = videoFile.path || '';
            let dirPath = '';
            if (filePath.includes('/')) {
                dirPath = filePath.substring(0, filePath.lastIndexOf('/'));
            } else {
                dirPath = '';
            }
            // Garante que o diretório comece com /
            if (!dirPath.startsWith('/')) {
                dirPath = '/' + dirPath;
            }
            // Caminho completo do arquivo para o parâmetro file
            let fullFilePath = filePath;
            if (!fullFilePath.startsWith('/')) {
                fullFilePath = '/' + fullFilePath;
            }
            // Construir a URL solicitada
            const infoHash = torrent.infoHash;
            const webtorUrl = `https://webtor.io/${infoHash}?pwd=${encodeURIComponent(dirPath)}&file=${encodeURIComponent(fullFilePath)}#action=download`;
            log('URL Webtor: ' + webtorUrl);
            console.log('URL Webtor:', webtorUrl);

            console.log('Iniciando a obtenção da Blob URL para o arquivo de vídeo...');

            videoFile.getBlobURL((err, url) => {
                if (err) {
                    console.error('Erro ao obter Blob URL:', err);
                    log('Erro ao obter Blob URL: ' + err.message);
                    statusOverlay.innerHTML = 'Erro ao carregar o vídeo.';
                    return;
                }

                console.log('Blob URL obtida com sucesso:', url);
                log('Blob URL obtida. Configurando o player...');

                // Oculta a sobreposição e mostra o player
                statusOverlay.style.opacity = '0';
                setTimeout(() => {
                    statusOverlay.style.display = 'none';
                }, 500);
                
                const player = videojs(videoPlayerElement);
                player.src({ src: url, type: 'video/mp4' });
                
                player.play().catch(error => {
                    console.warn('Reprodução automática bloqueada pelo navegador:', error);
                    log('Reprodução automática bloqueada. Por favor, clique para iniciar.');
                });

                log('Player do Video.js pronto para reprodução.');
            });

            console.log('Iniciando o loop de atualização do progresso...');
            const interval = setInterval(() => {
                const progress = (torrent.progress * 100).toFixed(1);
                const downloadSpeed = (torrent.downloadSpeed / 1024 / 1024).toFixed(2);
                statusOverlay.innerHTML = `Baixando: <strong>${progress}%</strong><br>Velocidade: <strong>${downloadSpeed} MB/s</strong>`;
                console.log(`Progresso: ${progress}%, Velocidade: ${downloadSpeed} MB/s`);
            }, 1000);

            torrent.on('done', () => {
                console.log('Evento "done" disparado. Download completo.');
                log('Download concluído!');
                clearInterval(interval);
                statusOverlay.innerHTML = `Download concluído! Agora seeding.`;
                statusOverlay.style.display = 'flex';
                statusOverlay.style.opacity = '1';
            });

        } else {
            statusOverlay.innerHTML = 'Nenhum arquivo de vídeo compatível (.mp4, .webm) encontrado no torrent.';
            log('Erro: Nenhum arquivo de vídeo compatível encontrado.');
            console.error('Erro: Nenhum arquivo de vídeo compatível encontrado no torrent.');
        }
    }

    function log(str) {
        const p = document.createElement('p');
        p.innerHTML = str;
        document.querySelector('.log').appendChild(p);
        console.log('Adicionando ao log na tela: ' + str);
    }
</script>

</body>
</html>
