<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TorrentStream</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- WebTorrent CDN -->
  <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
  <!-- Moment.js for human-readable time -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/es.js"></script>
  <!-- Custom Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      /* Remover overflow: hidden para permitir rolagem */
      width: 100%;
      height: 100%;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #121212;
    }

    .card {
      background-color: #1e1e1e;
      border: 1px solid #2d2d2d;
    }

    .custom-checkbox:checked {
      background-color: #22d3ee;
      border-color: #22d3ee;
    }

    .custom-checkbox:checked::after {
      content: '✓';
      color: #1e1e1e;
      display: block;
      text-align: center;
      line-height: 1.25rem;
      font-weight: bold;
    }

    .details-modal-grid {
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .details-modal-grid {
        grid-template-columns: 200px 1fr;
      }
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    #video-container,
    #details-video-container {
      min-height: 300px;
      width: 100%;
      background: #000;
    }

    #video-container video,
    #details-video-container video {
      width: 100%;
      height: 80vh;
      max-height: 80vh;
      background: #000;
      display: block;
    }
  </style>
</head>

<body class="text-gray-300">

  <div class="container mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <h1 class="text-2xl font-bold text-white tracking-wider" data-i18n="title">TorrentStream</h1>
      <div class="relative" id="lang-switcher">
        <button id="lang-btn" class="w-8 h-8 rounded-full overflow-hidden focus:outline-none ring-2 ring-transparent hover:ring-cyan-400 transition-all">
          <img src="https://flagcdn.com/w40/br.png" alt="Idioma" id="current-lang-flag" class="w-full h-full object-cover">
        </button>
        <div id="lang-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-20 border border-gray-700">
          <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-lang="pt">
            <img src="https://flagcdn.com/w40/br.png" alt="Brazilian flag with green background, yellow diamond, blue globe with white stars and band, representing Portuguese language selection" class="w-5 h-5 object-cover mr-3 rounded-sm"> Português
          </a>
          <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-lang="en">
            <img src="https://flagcdn.com/w40/us.png" alt="United States flag with red and white stripes and blue field with white stars, representing English language selection" class="w-5 h-5 object-cover mr-3 rounded-sm"> English
          </a>
          <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-lang="es">
            <img src="https://flagcdn.com/w40/es.png" alt="Spanish flag with red and yellow horizontal stripes and coat of arms, representing Spanish language selection" class="w-5 h-5 object-cover mr-3 rounded-sm"> Español
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content Grid -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Left Column -->
      <div class="lg:col-span-1 flex flex-col gap-8">

        <!-- Adicionar Torrent Card -->
        <div class="card rounded-lg p-6">
          <h2 class="text-lg font-semibold text-white mb-1 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-cyan-400">
              <path d="M5 12h14" />
              <path d="M12 5v14" />
            </svg>
            <span data-i18n="addTorrentTitle">Adicionar Torrent</span>
          </h2>
          <p class="text-sm text-gray-400 mb-4" data-i18n="addTorrentDesc">Cole um link magnético, hash ou URL de torrent para começar a transmitir.</p>
          <input id="torrent-input" type="text" data-i18n-placeholder="addTorrentPlaceholder" placeholder="magnet:, hash or url" class="w-full bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-400 mb-4">
          <button id="add-torrent-btn" data-i18n="addTorrentBtn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
            Adicionar Torrent
          </button>
        </div>

        <!-- Buscar Torrents Card -->
        <div class="card rounded-lg p-6">
          <h2 class="text-lg font-semibold text-white mb-1 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-cyan-400">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
            <span data-i18n="searchTorrentsTitle">Buscar Torrents</span>
          </h2>
          <p class="text-sm text-gray-400 mb-4" data-i18n="searchTorrentsDesc">Encontre torrents em sites públicos populares.</p>
          <div class="relative flex">
            <input id="search-input" type="text" data-i18n-placeholder="searchTorrentsPlaceholder" placeholder="Busque por filmes, séries, etc." class="w-full bg-gray-800 border border-gray-600 rounded-l-md pl-4 pr-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <button id="search-btn" class="px-4 bg-cyan-500 hover:bg-cyan-600 text-white rounded-r-md">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.3-4.3" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Sugestões de Conteúdo Card -->
        <div class="card rounded-lg p-6">
          <h2 class="text-lg font-semibold text-white mb-1 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-cyan-400">
              <path d="m12 3-1.9 5.8-5.9.8 4.2 4.1-.9 5.8 5.2-2.7 5.2 2.7-.9-5.8 4.2-4.1-5.9-.8Z" />
            </svg>
            <span data-i18n="suggestionsTitle">Sugestões de Conteúdo</span>
          </h2>
          <p class="text-sm text-gray-400 mb-4" data-i18n="suggestionsDesc">Receba sugestões da IA baseadas nos seus interesses.</p>
          <p class="text-sm font-medium text-white mb-2" data-i18n="suggestionsPreferences">Selecione suas preferências:</p>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catMovies">Filmes</span></label>
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catSeries">Séries</span></label>
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catDocs">Documentários</span></label>
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catAnime">Anime</span></label>
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catMusic">Música</span></label>
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catGames">Jogos</span></label>
            <label class="flex items-center space-x-2"><input type="checkbox" class="w-5 h-5 bg-gray-700 border-gray-600 rounded appearance-none custom-checkbox"><span data-i18n="catSports">Esportes</span></label>
          </div>
          <button class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md transition-colors mt-4" data-i18n="suggestionsBtn">
            Sugerir Conteúdo
          </button>
        </div>
      </div>

      <!-- Right Column -->
      <div class="lg:col-span-2">
        <!-- Campo de busca isolado -->
        <div class="flex items-center gap-2 mb-4">
          <input id="query_term" type="text" placeholder="Buscar Título/IMDb Code, Ator/IMDb Code, Direção/IMDb Code..." class="bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white placeholder-gray-500 w-full">
          <button id="search-movies-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded-md flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.3-4.3" />
            </svg>
          </button>
        </div>
        <!-- Filtros de Busca -->
        <div class="grid grid-cols-5 gap-4 mb-6 w-full">
          <select id="quality" class="bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white w-full">
            <option value="">Qualidade</option>
            <option value="480p">480p</option>
            <option value="720p">720p</option>
            <option value="1080p">1080p</option>
            <option value="1080p.x265">1080p.x265</option>
            <option value="2160p">2160p</option>
            <option value="3D">3D</option>
          </select>
          <select id="genre" class="bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white w-full">
            <option value="">Gênero</option>
            <option value="action">Ação</option>
            <option value="comedy">Comédia</option>
            <option value="drama">Drama</option>
            <option value="horror">Terror</option>
            <option value="romance">Romance</option>
            <option value="sci-fi">Sci-Fi</option>
            <option value="animation">Animação</option>
            <option value="documentary">Documentário</option>
            <option value="adventure">Aventura</option>
            <option value="crime">Crime</option>
            <option value="thriller">Thriller</option>
            <option value="fantasy">Fantasia</option>
            <option value="mystery">Mistério</option>
            <option value="music">Música</option>
            <option value="family">Família</option>
            <option value="war">Guerra</option>
            <option value="western">Western</option>
          </select>
          <select id="minimum_rating" class="bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white w-full">
            <option value="">Nota mínima</option>
            <option value="9">9+</option>
            <option value="8">8+</option>
            <option value="7">7+</option>
            <option value="6">6+</option>
            <option value="5">5+</option>
            <option value="4">4+</option>
            <option value="3">3+</option>
            <option value="2">2+</option>
            <option value="1">1+</option>
          </select>
          <select id="sort_by" class="bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white w-full">
            <option value="">Ordenar por</option>
            <option value="title">Título</option>
            <option value="year">Ano</option>
            <option value="rating">Nota</option>
            <option value="download_count">Downloads</option>
            <option value="like_count">Likes</option>
            <option value="date_added">Data Adicionada</option>
          </select>
          <select id="order_by" class="bg-gray-800 border border-gray-600 rounded-md px-4 py-2 text-white w-full">
            <option value="desc">Descendente</option>
            <option value="asc">Ascendente</option>
          </select>
        </div>
        <!-- Grid de Filmes -->
        <div id="movies-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8"></div>
        <!-- Paginação e Limite -->
        <div class="flex justify-between items-center mb-8 w-full">
          <div class="flex items-center gap-2">
            <label for="limit" class="text-white">Limite:</label>
            <input id="limit" type="number" min="1" max="50" value="50" class="bg-gray-800 border border-gray-600 rounded-md px-2 py-1 text-white w-16">
          </div>
          <div id="pagination-controls" class="flex items-center gap-2"></div>
          <div class="text-white font-bold" id="total-pages-info"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Profile Icon (Fixed) -->
  <div class="fixed bottom-6 left-6">
    <div class="w-10 h-10 bg-gray-800 border border-gray-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
      N
    </div>
  </div>

  <!-- Video Player Modal -->
  <div id="video-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
    <div class="card rounded-lg w-full max-w-4xl max-h-full overflow-hidden flex flex-col">
      <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
        <h3 class="text-xl font-semibold text-white" data-i18n="modalTitle">Streaming Torrent</h3>
        <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div id="video-container" class="p-1 sm:p-4 bg-black flex-grow flex items-center justify-center"></div>
    </div>
  </div>

  <!-- Movie Details Modal -->
  <div id="movie-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
    <div class="card rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
        <h3 id="details-modal-title" class="text-xl font-semibold text-white truncate">Carregando...</h3>
        <button id="details-close-modal-btn" class="text-gray-400 hover:text-white transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="p-4 md:p-6 overflow-y-auto scrollbar-hide">
        <div id="details-content" class="hidden">
          <div class="grid gap-4 md:gap-6 details-modal-grid">
            <img id="details-cover" src="" alt="Capa do Filme" class="w-full h-auto object-cover rounded-md">
            <div>
              <div class="flex items-center space-x-4 text-sm text-gray-400 mb-4">
                <span id="details-year"></span>
                <span class="flex items-center"><svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg><span id="details-rating"></span></span>
                <span id="details-runtime"></span>
                <span id="details-language"></span>
              </div>
              <p class="text-sm text-gray-400 mb-4" id="details-genres"></p>
              <p class="text-base text-gray-300 mb-4" id="details-synopsis"></p>
              <div id="details-torrents-list" class="flex flex-wrap gap-2"></div>
              <!-- Cast Section -->
              <div id="details-cast-container" class="mt-6 hidden">
                <h3 class="text-lg font-semibold text-white mb-3" data-i18n="castTitle">Elenco</h3>
                <div id="details-cast" class="flex overflow-x-auto gap-4 scrollbar-hide pb-2">
                  <!-- Membros do elenco serão inseridos aqui -->
                </div>
              </div>
            </div>
          </div>
          <div id="details-video-container" class="mt-4 bg-black"></div>

          <!-- Screenshots Section -->
          <div id="details-screenshots-container" class="mt-6 hidden">
            <h3 class="text-lg font-semibold text-white mb-3" data-i18n="screenshotsTitle">Screenshots</h3>
            <div class="relative">
              <div id="details-screenshots" class="flex overflow-x-auto snap-x snap-mandatory scroll-smooth scrollbar-hide gap-4">
                <!-- Imagens do screenshot serão inseridos aqui -->
              </div>
              <button id="scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full opacity-50 hover:opacity-100 transition-opacity">&lt;</button>
              <button id="scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full opacity-50 hover:opacity-100 transition-opacity">&gt;</button>
            </div>
          </div>

        </div>
        <div id="details-loading" class="text-center p-8" data-i18n="loadingDetails">Carregando detalhes do filme...</div>
      </div>
    </div>
  </div>

  <video id="video-player" controls style="width:100%;max-width:900px;margin:32px auto;display:block;background:#000;"></video>
  <script>
    const client = new WebTorrent();
    const player = document.getElementById('video-player');

    function buildMagnetURI(hashOrMagnet) {
      let magnet = hashOrMagnet;
      if (/^[a-fA-F0-9]{32,40}$/.test(hashOrMagnet)) {
        magnet = `magnet:?xt=urn:btih:${hashOrMagnet}`;
      }
      // Adiciona trackers globais
      const allTrackers = [...globalConfig.trackers.udp, ...globalConfig.trackers.http, ...globalConfig.trackers.ws];
      allTrackers.forEach(tr => {
        magnet += `&tr=${encodeURIComponent(tr)}`;
      });
      return magnet;
    }

    function download(magnetURI) {
      client.add(magnetURI, torrent => {
        const file = torrent.files.find(f => f.name.endsWith('.mp4') || f.name.endsWith('.mkv') || f.name.endsWith('.webm'));
        if (file) {
  const url = file.streamURL;
  console.log('[WebTorrent] Arquivo de vídeo encontrado:', file.name);
  console.log('[WebTorrent] Caminho completo dentro do torrent:', file.path);
  console.log('[WebTorrent] streamURL (para o player):', url);
  player.src = url;
  player.play();
} else {
          console.warn('[WebTorrent] Nenhum arquivo de vídeo encontrado no torrent.');
        }
      });
    }
    navigator.serviceWorker.register('./sw.min.js', {
      scope: './'
    }).then(reg => {
      const worker = reg.active || reg.waiting || reg.installing;

      function checkState(worker) {
        if (worker.state === 'activated') {
          // Não chama download aqui, aguarda ação do usuário
          return true;
        }
        return false;
      }
      if (!checkState(worker)) {
        worker.addEventListener('statechange', ({
          target
        }) => checkState(target));
      }
    });
    // Evento para input do usuário
    const torrentInput = document.getElementById('torrent-input');
    const addTorrentBtn = document.getElementById('add-torrent-btn');
    addTorrentBtn.addEventListener('click', () => {
      const value = torrentInput.value.trim();
      if (value) {
        const magnetURI = buildMagnetURI(value);
        download(magnetURI);
      }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Configurações e Variaveis Globais ---
      const globalConfig = {
        trackers: {
          udp: [
            "udp://1c.premierzal.ru:6969/announce", "udp://6ahddutb1ucc3cp.ru:6969/announce", "udp://bandito.byterunner.io:6969/announce", "udp://bt.bontal.net:6969/announce", "udp://d40969.acod.regrucolo.ru:6969/announce", "udp://evan.im:6969/announce", "udp://exodus.desync.com:6969", "udp://extracker.dahrkael.net:6969/announce", "udp://ipv4.tracker.harry.lu:80/announce", "udp://martin-gebhardt.eu:25/announce", "udp://open.demonii.com:1337/announce", "udp://open.stealth.si:80/announce", "udp://opentracker.io:6969/announce", "udp://p4p.arenabg.com:1337/announce", "udp://retracker.hotplug.ru:2710/announce", "udp://retracker.lanta.me:2710/announce", "udp://retracker01-msk-virt.corbina.net:80/announce", "udp://tr4ck3r.duckdns.org:6969/announce", "udp://tracker-de-2.cutie.dating:1337/announce", "udp://tracker.bitcoinindia.space:6969/announce", "udp://tracker.cloudbase.store:1333/announce", "udp://tracker.coppersurfer.tk:6969/announce", "udp://tracker.cyberia.is:6969/announce", "udp://tracker.dler.com:6969/announce", "udp://tracker.dler.org:6969/announce", "udp://tracker.ducks.party:1984/announce", "udp://tracker.fnix.net:6969/announce", "udp://tracker.gigantino.net:6969/announce", "udp://tracker.hifitechindia.com:6969/announce", "udp://tracker.openbittorrent.com:6969/announce", "udp://tracker.opentrackr.org:1337", "udp://tracker.opentrackr.org:1337/announce", "udp://tracker.plx.im:6969/announce", "udp://tracker.rescuecrew7.com:1337/announce", "udp://tracker.skillindia.site:6969/announce", "udp://tracker.srv00.com:6969/announce", "udp://tracker.startwork.cv:1337/announce", "udp://tracker.therarbg.to:6969/announce", "udp://tracker.tiny-vps.com:6969/announce", "udp://tracker.torrent.eu.org:451/announce", "udp://tracker.tryhackx.org:6969/announce", "udp://tracker.tvunderground.org.ru:3218/announce", "udp://tracker.valete.tf:9999/announce", "udp://tracker.zupix.online:1333/announce", "udp://ttk2.nbaonlineservice.com:6969/announce", "udp://www.torrent.eu.org:451/announce"
          ],
          http: [
            "http://0123456789nonexistent.com:80/announce", "http://bt.okmp3.ru:2710/announce", "http://bt1.archive.org:6969/announce", "http://bt2.archive.org:6969/announce", "http://ipv4.rer.lol:2710/announce", "http://ipv6.rer.lol:6969/announce", "http://lucke.fenesisu.moe:6969/announce", "http://open.trackerlist.xyz:80/announce", "http://p4p.arenabg.com:1337/announce", "http://shubt.net:2710/announce", "http://torrent.hificode.in:6969/announce", "http://tracker.beeimg.com:6969/announce", "http://tracker.bt4g.com:2095/announce", "http://tracker.ipv6tracker.ru:80/announce", "http://tracker.mywaifu.best:6969/announce", "http://tracker.renfei.net:8080/announce", "https://1.tracker.eu.org:443/announce", "https://2.tracker.eu.org:443/announce", "https://3.tracker.eu.org:443/announce", "https://4.tracker.eu.org:443/announce", "https://opentracker.i2p.rocks:443/announce", "https://torrent.tracker.durukanbal.com:443/announce", "https://tr.nyacat.pw:443/announce", "https://tracker.alaskantf.com:443/announce", "https://tracker.expli.top:443/announce", "https://tracker.jdx3.org:443/announce", "https://tracker.moeblog.cn:443/announce", "https://tracker.yemekyedim.com:443/announce", "https://tracker.zhuqiy.top:443/announce"
          ],
          ws: [
            "wss://tracker.btorrent.xyz", "wss://tracker.fastcast.nz", "wss://tracker.openwebtorrent.com",
          ],
        }
      };
      // --- I18N (Internationalization) ---
      const translations = {
        'pt': {
          title: "TorrentStream",
          addTorrentTitle: "Adicionar Torrent",
          addTorrentDesc: "Cole um link magnético, hash ou URL de torrent para começar a transmitir.",
          addTorrentPlaceholder: "magnet:, hash or url",
          addTorrentBtn: "Adicionar Torrent",
          searchTorrentsTitle: "Buscar Torrents",
          searchTorrentsDesc: "Encontre torrents em sites públicos populares.",
          searchTorrentsPlaceholder: "Busque por filmes, séries, ou IMDb ID",
          suggestionsTitle: "Sugestões de Conteúdo",
          suggestionsDesc: "Receba sugestões da IA baseadas nos seus interesses.",
          suggestionsPreferences: "Selecione suas preferências:",
          catMovies: "Filmes",
          catSeries: "Séries",
          catDocs: "Documentários",
          catAnime: "Anime",
          catMusic: "Música",
          catGames: "Jogos",
          catSports: "Esportes",
          suggestionsBtn: "Sugerir Conteúdo",
          myTorrentsTitle: "Meus Torrents",
          myTorrentsDesc: "Sua coleção de torrents prontos para transmitir.",
          streamBtn: "Transmitir",
          streamBtn2: "Transmitir",
          modalTitle: "A transmitir Torrent",
          invalidTorrent: "Link magnético ou hash inválido.",
          imdbNotFound: "Filme não encontrado para o IMDb ID fornecido.",
          loadingDetails: "A carregar detalhes do filme...",
          langEn: "Inglês",
          langEs: "Espanhol",
          langPt: "Português",
          langFr: "Francês",
          langDe: "Alemão",
          langIt: "Italiano",
          langJa: "Japonês",
          langKo: "Coreano",
          langRu: "Russo",
          langZh: "Chinês",
          langDefault: "Desconhecido",
          screenshotsTitle: "Capturas de Ecrã",
          castTitle: "Elenco",
          connectingToPeers: "A conectar a peers...",
          downloading: "A descarregar",
          peers: "peers",
          torrentError: "Erro ao carregar o torrent. Verifique o link ou tente mais tarde.",
          noVideoFile: "Nenhum ficheiro de vídeo compatível encontrado no torrent.",
          uploadSpeed: "Velocidade de Upload",
          remainingTime: "restantes",
          downloaded: "Descarregado",
          totalSize: "Total",
          done: "Concluído",
          seeding: "A semear",
        },
        'en': {
          title: "TorrentStream",
          addTorrentTitle: "Add Torrent",
          addTorrentDesc: "Paste a magnet link, hash, or torrent URL to start streaming.",
          addTorrentPlaceholder: "magnet:, hash or url",
          addTorrentBtn: "Add Torrent",
          searchTorrentsTitle: "Search Torrents",
          searchTorrentsDesc: "Find torrents on popular public sites.",
          searchTorrentsPlaceholder: "Search for movies, series, or IMDb ID",
          suggestionsTitle: "Content Suggestions",
          suggestionsDesc: "Get AI suggestions based on your interests.",
          suggestionsPreferences: "Select your preferences:",
          catMovies: "Movies",
          catSeries: "Series",
          catDocs: "Documentaries",
          catAnime: "Anime",
          catMusic: "Music",
          catGames: "Games",
          catSports: "Sports",
          suggestionsBtn: "Suggest Content",
          myTorrentsTitle: "My Torrents",
          myTorrentsDesc: "Your collection of torrents ready to stream.",
          streamBtn: "Stream",
          streamBtn2: "Stream",
          modalTitle: "Streaming Torrent",
          invalidTorrent: "Invalid magnet link or hash.",
          imdbNotFound: "Movie not found for the provided IMDb ID.",
          loadingDetails: "Loading movie details...",
          langEn: "English",
          langEs: "Spanish",
          langPt: "Portuguese",
          langFr: "French",
          langDe: "German",
          langIt: "Italian",
          langJa: "Japanese",
          langKo: "Korean",
          langRu: "Russian",
          langZh: "Chinese",
          langDefault: "Unknown",
          screenshotsTitle: "Screenshots",
          castTitle: "Cast",
          connectingToPeers: "Connecting to peers...",
          downloading: "Downloading",
          peers: "peers",
          torrentError: "Error loading torrent. Check the link or try again later.",
          noVideoFile: "No compatible video file found in the torrent.",
          uploadSpeed: "Upload Speed",
          remainingTime: "remaining",
          downloaded: "Downloaded",
          totalSize: "Total",
          done: "Done",
          seeding: "Seeding",
        },
        'es': {
          title: "TorrentStream",
          addTorrentTitle: "Añadir Torrent",
          addTorrentDesc: "Pega un enlace magnético, hash o URL de torrent para empezar a transmitir.",
          addTorrentPlaceholder: "magnet:, hash or url",
          addTorrentBtn: "Añadir Torrent",
          searchTorrentsTitle: "Buscar Torrents",
          searchTorrentsDesc: "Encuentra torrents en sitios públicos populares.",
          searchTorrentsPlaceholder: "Buscar películas, series, o IMDb ID",
          suggestionsTitle: "Sugerencias de Contenido",
          suggestionsDesc: "Recibe sugerencias de la IA basadas en tus intereses.",
          suggestionsPreferences: "Selecciona tus preferencias:",
          catMovies: "Películas",
          catSeries: "Series",
          catDocs: "Documentales",
          catAnime: "Anime",
          catMusic: "Música",
          catGames: "Juegos",
          catSports: "Deportes",
          suggestionsBtn: "Sugerir Conteúdo",
          myTorrentsTitle: "Mis Torrents",
          myTorrentsDesc: "Tu colección de torrents listos para transmitir.",
          streamBtn: "Transmitir",
          streamBtn2: "Transmitir",
          modalTitle: "Transmitiendo Torrent",
          invalidTorrent: "Enlace magnético o hash no válido.",
          imdbNotFound: "No se encontró la película para el ID de IMDb proporcionado.",
          loadingDetails: "Cargando detalles de la película...",
          langEn: "Inglés",
          langEs: "Español",
          langPt: "Português",
          langFr: "Francés",
          langDe: "Alemán",
          langIt: "Italiano",
          langJa: "Japonés",
          langKo: "Coreano",
          langRu: "Ruso",
          langZh: "Chino",
          langDefault: "Desconocido",
          screenshotsTitle: "Capturas de Pantalla",
          castTitle: "Elenco",
          connectingToPeers: "Conectando a pares...",
          downloading: "Descargando",
          peers: "pares",
          torrentError: "Error al cargar el torrent. Compruebe el enlace o inténtelo de nuevo más tarde.",
          noVideoFile: "No se encontró ningún archivo de vídeo compatible en el torrent.",
          uploadSpeed: "Velocidad de Subida",
          remainingTime: "restantes",
          downloaded: "Descargado",
          totalSize: "Total",
          done: "Completado",
          seeding: "Sembrando",
        }
      };
      const langSwitcher = document.getElementById('lang-switcher');
      const langBtn = document.getElementById('lang-btn');
      const currentLangFlag = document.getElementById('current-lang-flag');
      const langDropdown = document.getElementById('lang-dropdown');
      let currentLang = 'en';
      const setLanguage = (lang) => {
        if (!translations[lang]) return;
        currentLang = lang;
        document.documentElement.lang = lang;
        currentLangFlag.src = `https://flagcdn.com/w40/${lang === 'en' ? 'us' : lang}.png`;
        moment.locale(lang === 'pt' ? 'pt-br' : lang);
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          el.innerText = translations[lang][key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          el.placeholder = translations[lang][key];
        });
      };
      const getInitialLang = () => {
        const browserLang = (navigator.language || navigator.userLanguage).slice(0, 2);
        return translations[browserLang] ? browserLang : 'en';
      };
      langBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        langDropdown.classList.toggle('hidden');
      });
      document.addEventListener('click', () => {
        langDropdown.classList.add('hidden');
      });
      langDropdown.addEventListener('click', (e) => {
        const lang = e.target.closest('a')?.dataset.lang;
        if (lang) {
          e.preventDefault();
          setLanguage(lang);
        }
      });
      // --- CORE APP LOGIC ---
      const torrentInput = document.getElementById('torrent-input');
      const addTorrentBtn = document.getElementById('add-torrent-btn');
      const videoModal = document.getElementById('video-modal');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const videoContainer = document.getElementById('video-container');
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-btn');
      const movieDetailsModal = document.getElementById('movie-details-modal');
      const detailsCloseModalBtn = document.getElementById('details-close-modal-btn');
      let webTorrentClient = null;
      let statusInterval = null;
      const prettyBytes = (num) => {
        const units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        if (!Number.isFinite(num)) {
          return '0 B';
        }
        const neg = num < 0;
        if (neg) num = -num;
        if (num < 1) return (neg ? '-' : '') + num + ' B';
        const exponent = Math.min(Math.floor(Math.log10(num) / 3), units.length - 1);
        const unit = units[exponent];
        num = Number((num / Math.pow(1000, exponent)).toPrecision(3));
        return (neg ? '-' : '') + num + ' ' + unit;
      }
      const playTorrent = (hash, containerId) => {
        console.log('[WebTorrent] Iniciando processamento do torrent:', hash);
        destroyPlayer();
        webTorrentClient = new WebTorrent();
        let magnetLink = `magnet:?xt=urn:btih:${hash}&dn=${encodeURIComponent(hash)}`;
        const allTrackers = [...globalConfig.trackers.udp, ...globalConfig.trackers.http, ...globalConfig.trackers.ws];
        allTrackers.forEach(tracker => {
          magnetLink += `&tr=${encodeURIComponent(tracker)}`;
        });
        console.log('[WebTorrent] Magnet link construído:', magnetLink);
        const container = document.getElementById(containerId);
        container.innerHTML = `
                    <div id="torrent-status" class="w-full h-full flex flex-col justify-center items-center text-white p-4">
                        <p id="status-message" class="text-lg mb-4">${translations[currentLang].connectingToPeers}</p>
                        <div class="w-full max-w-md bg-gray-700 rounded-full h-2.5 mb-2">
                            <div id="progress-bar" class="bg-cyan-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="w-full max-w-md flex justify-between text-xs text-gray-400 mb-4">
                            <span><span id="downloaded-amount">0 B</span> / <span id="total-amount">...</span></span>
                            <span id="time-remaining">--:--</span>
                        </div>
                        <div class="w-full max-w-md grid grid-cols-3 gap-4 text-center text-sm">
                            <div>
                                <div class="font-bold text-cyan-400" id="download-speed">↓ 0 B/s</div>
                                <div class="text-xs text-gray-500" data-i18n="downloading">${translations[currentLang].downloading}</div>
                            </div>
                             <div>
                                <div class="font-bold text-green-400" id="upload-speed">↑ 0 B/s</div>
                                <div class="text-xs text-gray-500" data-i18n="uploadSpeed">${translations[currentLang].uploadSpeed}</div>
                            </div>
                            <div>
                                <div class="font-bold text-yellow-400" id="peer-count">0</div>
                                <div class="text-xs text-gray-500" data-i18n="peers">${translations[currentLang].peers}</div>
                            </div>
                        </div>
                    </div>
                `;
        webTorrentClient.add(magnetLink, (torrent) => {
          console.log('[WebTorrent] Torrent adicionado, aguardando metadados...');
          const file = torrent.files.find(file => file.name.endsWith('.mp4') || file.name.endsWith('.mkv') || file.name.endsWith('.webm'));
          if (!file) {
            console.warn('[WebTorrent] Nenhum arquivo de vídeo compatível encontrado no torrent.');
            document.querySelector('#status-message').textContent = translations[currentLang].noVideoFile;
            destroyPlayer();
            return;
          }
          console.log('[WebTorrent] Arquivo de vídeo encontrado:', file.name);
          const updateStatus = () => {
            const statusContainer = document.getElementById('torrent-status');
            if (!statusContainer) {
              if (statusInterval) clearInterval(statusInterval);
              return;
            }
            const percent = (torrent.progress * 100).toFixed(1);
            statusContainer.querySelector('#progress-bar').style.width = `${percent}%`;
            statusContainer.querySelector('#downloaded-amount').textContent = prettyBytes(torrent.downloaded);
            statusContainer.querySelector('#total-amount').textContent = prettyBytes(torrent.length);
            statusContainer.querySelector('#download-speed').textContent = `↓ ${prettyBytes(torrent.downloadSpeed)}/s`;
            statusContainer.querySelector('#upload-speed').textContent = `↑ ${prettyBytes(torrent.uploadSpeed)}/s`;
            statusContainer.querySelector('#peer-count').textContent = torrent.numPeers;
            let remaining = '';
            if (torrent.done) {
              remaining = translations[currentLang].done;
            } else if (torrent.timeRemaining === Infinity) {
              remaining = '∞';
            } else {
              remaining = moment.duration(torrent.timeRemaining / 1000, 'seconds').humanize();
              remaining = remaining.charAt(0).toUpperCase() + remaining.slice(1) + ' ' + translations[currentLang].remainingTime;
            }
            statusContainer.querySelector('#time-remaining').textContent = remaining;
            if (torrent.progress < 1) {
              statusContainer.querySelector('#status-message').textContent = `${translations[currentLang].downloading} - ${percent}%`;
            }
          }
          torrent.on('ready', () => {
            console.log('[WebTorrent] Metadados prontos, iniciando renderização do player...');
            videoModal.classList.remove('hidden');
            container.innerHTML = '';
            file.appendTo(container, {
              controls: true
            });
            if (statusInterval) clearInterval(statusInterval);
          });
          torrent.on('done', () => {
            console.log('[WebTorrent] Download do torrent concluído!');
            const statusContainer = document.getElementById('torrent-status');
            if (statusContainer) {
              statusContainer.querySelector('#status-message').textContent = translations[currentLang].seeding;
              updateStatus();
            }
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = null;
          });
          statusInterval = setInterval(updateStatus, 500);
          console.log('[WebTorrent] Download iniciado...');
        });
        webTorrentClient.on('error', (err) => {
          console.error('[WebTorrent] Erro:', err);
          container.innerHTML = `<div class="text-red-400 text-center p-4">${translations[currentLang].torrentError}</div>`;
          destroyPlayer();
        });
      };
      const destroyPlayer = () => {
        if (statusInterval) {
          clearInterval(statusInterval);
          statusInterval = null;
        }
        if (webTorrentClient) {
          webTorrentClient.destroy();
          webTorrentClient = null;
        }
      };
      addTorrentBtn.addEventListener('click', () => {
        const torrentId = torrentInput.value.trim();
        const hashMatch = torrentId.match(/(?:magnet:\?xt=urn:btih:|\b)([a-fA-F0-9]{32,40})\b/);
        if (hashMatch && hashMatch[1]) {
          playTorrent(hashMatch[1], 'video-container');
          videoModal.classList.remove('hidden');
        } else {
          alert(translations[currentLang].invalidTorrent);
        }
      });
      const formatRuntime = (minutes) => {
        if (!minutes || typeof minutes !== 'number') return 'N/A';
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:00`;
      };
      const getTranslatedLangName = (langCode) => {
        if (!langCode) return translations[currentLang]['langDefault'];
        const key = `lang${langCode.charAt(0).toUpperCase() + langCode.slice(1)}`;
        return translations[currentLang][key] || langCode.toUpperCase();
      };
      const populateMovieDetails = (movie) => {
        document.getElementById('details-modal-title').textContent = movie.title_long || 'Detalhes do Filme';
        document.getElementById('details-cover').src = movie.large_cover_image || '';
        document.getElementById('details-year').textContent = movie.year || 'N/A';
        document.getElementById('details-rating').textContent = movie.rating || 'N/A';
        document.getElementById('details-runtime').textContent = formatRuntime(movie.runtime);
        const langElement = document.getElementById('details-language');
        const movieLangCode = movie.language;
        if (movieLangCode) {
          const flagCode = movieLangCode === 'en' ? 'us' : movieLangCode;
          const translatedLangName = getTranslatedLangName(movieLangCode);
          langElement.innerHTML = `<img src="https://flagcdn.com/w40/${flagCode}.png" alt="${translatedLangName}" class="w-5 h-auto mr-2 rounded-sm"><span class="truncate">${translatedLangName}</span>`;
          langElement.classList.add('flex', 'items-center');
        } else {
          langElement.textContent = 'N/A';
          langElement.classList.remove('flex', 'items-center');
        }
        document.getElementById('details-genres').textContent = movie.genres ? movie.genres.join(', ') : 'N/A';
        const synopsisElement = document.getElementById('details-synopsis');
        if (movie.description_full) {
          synopsisElement.textContent = movie.description_full;
          synopsisElement.style.display = 'block';
        } else {
          synopsisElement.textContent = '';
          synopsisElement.style.display = 'none';
        }
        const torrentsList = document.getElementById('details-torrents-list');
        torrentsList.innerHTML = '';
        if (movie.torrents && movie.torrents.length > 0) {
          movie.torrents.forEach(torrent => {
            const btn = document.createElement('button');
            btn.className = "px-3 py-1.5 bg-gray-700 hover:bg-cyan-600 text-cyan-400 hover:text-white rounded-md transition-colors text-sm";
            btn.textContent = `${torrent.quality} (${torrent.size})`;
            btn.onclick = () => playTorrent(torrent.hash, 'details-video-container');
            torrentsList.appendChild(btn);
          });
        }
        // Screenshots
        const screenshotsContainer = document.getElementById('details-screenshots-container');
        const screenshotsDiv = document.getElementById('details-screenshots');
        screenshotsDiv.innerHTML = '';
        const screenshots = [];
        if (movie.large_screenshot_image1) screenshots.push(movie.large_screenshot_image1);
        if (movie.large_screenshot_image2) screenshots.push(movie.large_screenshot_image2);
        if (movie.large_screenshot_image3) screenshots.push(movie.large_screenshot_image3);
        if (screenshots.length > 0) {
          screenshots.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.className = "h-48 object-cover rounded-md snap-center flex-shrink-0";
            screenshotsDiv.appendChild(img);
          });
          screenshotsContainer.classList.remove('hidden');
        } else {
          screenshotsContainer.classList.add('hidden');
        }
        // Cast
        const castContainer = document.getElementById('details-cast-container');
        const castDiv = document.getElementById('details-cast');
        castDiv.innerHTML = '';
        if (movie.cast && movie.cast.length > 0) {
          movie.cast.forEach(actor => {
            const actorCard = `
                            <div class="text-center w-24 flex-shrink-0">
                                <a href="https://www.imdb.com/name/nm${actor.imdb_code}/" target="_blank" rel="noopener noreferrer">
                                    <img src="${actor.url_small_image || 'https://placehold.co/150x225/1e1e1e/a0aec0?text=S/Foto'}" alt="${actor.name}" class="w-24 h-36 object-cover rounded-md mb-1" onerror="this.onerror=null;this.src='https://placehold.co/150x225/1e1e1e/a0aec0?text=S/Foto';">
                                </a>
                                <p class="font-semibold text-xs text-white truncate">${actor.name}</p>
                                <p class="text-xs text-gray-400 truncate">${actor.character_name || ''}</p>
                            </div>
                        `;
            castDiv.innerHTML += actorCard;
          });
          castContainer.classList.remove('hidden');
        } else {
          castContainer.classList.add('hidden');
        }
        document.getElementById('details-loading').style.display = 'none';
        document.getElementById('details-content').style.display = 'block';
      };
      const handleSearch = async () => {
        const query = searchInput.value.trim();
        const imdbMatch = query.match(/(tt\d{7,8}|\d{7,8})$/);
        if (imdbMatch) {
          const imdbId = imdbMatch[0];
          console.log('[API] Iniciando busca de filme na API YTS para IMDb ID:', imdbId);
          movieDetailsModal.classList.remove('hidden');
          document.getElementById('details-loading').style.display = 'block';
          document.getElementById('details-content').style.display = 'none';
          document.getElementById('details-video-container').innerHTML = '';
          try {
            const response = await fetch(`https://yts.mx/api/v2/movie_details.json?imdb_id=${imdbId}&with_images=true&with_cast=true`);
            const data = await response.json();
            console.log('[API] Resposta recebida da API YTS:', data);
            if (data.status === 'ok' && data.data.movie && data.data.movie.id !== 0) {
              console.log('[API] Filme encontrado:', data.data.movie.title_long);
              populateMovieDetails(data.data.movie);
            } else {
              console.warn('[API] Filme não encontrado para o IMDb ID fornecido.');
              alert(translations[currentLang].imdbNotFound);
              movieDetailsModal.classList.add('hidden');
            }
          } catch (error) {
            console.error('[API] Falha ao buscar detalhes do filme:', error);
            alert('Falha ao buscar detalhes do filme.');
            movieDetailsModal.classList.add('hidden');
          }
        } else {
          console.log('[Busca] Busca normal por:', query);
        }
      };
      searchBtn.addEventListener('click', handleSearch);
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSearch();
      });
      closeModalBtn.addEventListener('click', () => {
        videoModal.classList.add('hidden');
        videoContainer.innerHTML = '';
        destroyPlayer();
      });
      detailsCloseModalBtn.addEventListener('click', () => {
        movieDetailsModal.classList.add('hidden');
        document.getElementById('details-video-container').innerHTML = '';
        destroyPlayer();
      });
      // Carousel controls
      document.getElementById('scroll-left').addEventListener('click', () => {
        document.getElementById('details-screenshots').scrollBy({
          left: -300,
          behavior: 'smooth'
        });
      });
      document.getElementById('scroll-right').addEventListener('click', () => {
        document.getElementById('details-screenshots').scrollBy({
          left: 300,
          behavior: 'smooth'
        });
      });
      // Função para montar URL da API e atualizar a URL do app
      function getFilters() {
        return {
          query_term: document.getElementById('query_term').value.trim(),
          quality: document.getElementById('quality').value,
          genre: document.getElementById('genre').value,
          minimum_rating: document.getElementById('minimum_rating').value,
          sort_by: document.getElementById('sort_by').value,
          order_by: document.getElementById('order_by').value,
          limit: document.getElementById('limit').value,
          page: window.currentPage || 1
        };
      }

      function buildApiUrl() {
        const base = 'https://yts.mx/api/v2/list_movies.json';
        const filters = getFilters();
        const params = Object.entries(filters).filter(([k, v]) => v).map(([k, v]) => `${k}=${encodeURIComponent(v)}`).join('&');
        return `${base}?${params}`;
      }

      function updateAppUrl() {
        const filters = getFilters();
        const params = Object.entries(filters).filter(([k, v]) => v).map(([k, v]) => `${k}=${encodeURIComponent(v)}`).join('&');
        window.history.replaceState({}, '', `?${params}`);
      }
      let firstLoad = true;
      async function fetchMovies() {
        const url = buildApiUrl();
        if (!firstLoad) updateAppUrl();
        document.getElementById('movies-grid').innerHTML = '<div class="text-center text-white p-8">Carregando...</div>';
        try {
          const res = await fetch(url);
          const data = await res.json();
          renderMovies(data.data.movies || []);
          renderPagination(data.data);
        } catch (e) {
          document.getElementById('movies-grid').innerHTML = '<div class="text-center text-red-400 p-8">Erro ao buscar filmes.</div>';
        }
        firstLoad = false;
      }

      function renderMovies(movies) {
        const grid = document.getElementById('movies-grid');
        if (!movies.length) {
          grid.innerHTML = '<div class="text-center text-white p-8">Nenhum filme encontrado.</div>';
          return;
        }
        grid.innerHTML = movies.map(movie => `
    <div class="bg-gray-900 rounded-lg overflow-hidden shadow-lg flex flex-col">
      <img src="${movie.medium_cover_image}" alt="${movie.title}" class="w-full h-64 object-cover">
      <div class="p-4 flex-1 flex flex-col">
        <h3 class="text-lg font-bold text-white mb-2">${movie.title}</h3>
        <p class="text-sm text-gray-400 mb-2">${movie.year} &middot; ${movie.rating} &middot; ${movie.genres?.join(', ') || ''}</p>
        <p class="text-xs text-gray-500 mb-2 line-clamp-3">${movie.summary || ''}</p>
        <button class="mt-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-md" onclick="playTorrent('${movie.torrents[0]?.hash}','video-container')">Transmitir</button>
      </div>
    </div>
  `).join('');
      }

      function renderPagination(data) {
        const page = data.page_number || 1;
        const limit = data.limit || 20;
        const total = data.movie_count || 0;
        const totalPages = Math.ceil(total / limit);
        window.currentPage = page;
        // Renderizar paginação centralizada
        const pagination = document.getElementById('pagination-controls');
        let html = '';
        html += `<button id='first-page' class='bg-gray-700 text-white px-2 py-1 rounded-md' ${page===1?'disabled':''}>Primeira</button>`;
        html += `<button id='prev-page' class='bg-gray-700 text-white px-2 py-1 rounded-md' ${page===1?'disabled':''}>Anterior</button>`;
        let start = Math.max(1, page - 3);
        let end = Math.min(totalPages, start + 6);
        if (end - start < 6) start = Math.max(1, end - 6);
        for (let i = start; i <= end; i++) {
          html += `<button class='bg-gray-700 ${i===page?'bg-cyan-600':''} text-white px-2 py-1 rounded-md page-btn' data-page='${i}'>${i}</button>`;
        }
        html += `<button id='next-page' class='bg-gray-700 text-white px-2 py-1 rounded-md' ${page===totalPages?'disabled':''}>Próxima</button>`;
        html += `<button id='last-page' class='bg-gray-700 text-white px-2 py-1 rounded-md' ${page===totalPages?'disabled':''}>Última</button>`;
        pagination.innerHTML = html;
        document.getElementById('total-pages-info').textContent = `Total: ${totalPages} páginas`;
        // Eventos
        document.getElementById('first-page').onclick = () => {
          window.currentPage = 1;
          fetchMovies();
        };
        document.getElementById('last-page').onclick = () => {
          window.currentPage = totalPages;
          fetchMovies();
        };
        document.getElementById('prev-page').onclick = () => {
          window.currentPage = Math.max(1, page - 1);
          fetchMovies();
        };
        document.getElementById('next-page').onclick = () => {
          window.currentPage = Math.min(totalPages, page + 1);
          fetchMovies();
        };
        document.querySelectorAll('.page-btn').forEach(btn => {
          btn.onclick = () => {
            window.currentPage = Number(btn.dataset.page);
            fetchMovies();
          };
        });
      }
      // Eventos de filtro
      ['query_term', 'quality', 'genre', 'minimum_rating', 'sort_by', 'order_by', 'limit'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          window.currentPage = 1;
          fetchMovies();
        });
      });
      // Inicialização
      window.currentPage = 1;
      document.getElementById('limit').value = 16;
      fetchMovies();
      // Set initial language
      setLanguage(getInitialLang());
    });
  </script>
</body>

</html>
