<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Buscar URL de Vídeo via Magnetlink</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #player-container { margin-top: 20px; }
    #url-video { margin-top: 20px; font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h2>Buscar URL de Vídeo via Magnetlink</h2>
  <form id="form-magnet">
    <label for="magnet">Magnetlink:</label>
    <input type="text" id="magnet" name="magnet" placeholder="Cole o magnetlink aqui" required style="width: 80%;">
    <button type="submit">Buscar</button>
  </form>
  <div id="player-container"></div>
  <div id="url-video"></div>

  <script src="https://cdn.jsdelivr.net/npm/@webtor/embed-sdk-js/dist/index.min.js" charset="utf-8" async></script>
  <script>
    const form = document.getElementById('form-magnet');
    const playerContainer = document.getElementById('player-container');
    const urlVideoDiv = document.getElementById('url-video');

    function isMagnetLink(str) {
      return str.startsWith('magnet:?xt=urn:btih:');
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const magnet = document.getElementById('magnet').value.trim();
      if (!magnet || !isMagnetLink(magnet)) {
        urlVideoDiv.textContent = 'Magnetlink inválido!';
        return;
      }
      playerContainer.innerHTML = '';
      urlVideoDiv.textContent = 'Buscando...';

      // Cria o player embed Webtor
      const div = document.createElement('div');
      div.setAttribute('id', 'webtor-player');
      // Corrige: adiciona atributo allow corretamente
      div.setAttribute('allow', 'fullscreen');
      playerContainer.appendChild(div);
      window.webtor = window.webtor || [];
      window.webtor.push({
        id: 'webtor-player',
        magnet: magnet,
        width: 640,
        height: 360,
        on: {
          ready: function() {
            urlVideoDiv.textContent = 'Player carregado, aguardando requisições de vídeo...';
          },
          error: function(err) {
            urlVideoDiv.textContent = 'Erro ao carregar o player ou magnetlink inválido.';
          }
        }
      });
    });

    // Intercepta fetch
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      if (
        args[0] &&
        typeof args[0] === 'string' &&
        (args[0].includes('.m3u8') || args[0].includes('.mp4'))
      ) {
        urlVideoDiv.textContent = 'URL encontrada: ' + args[0];
        window.videoUrlEncontrada = args[0];
      }
      return originalFetch.apply(this, args);
    };

    // Intercepta XMLHttpRequest
    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url, ...rest) {
      if (
        url &&
        (url.includes('.m3u8') || url.includes('.mp4'))
      ) {
        urlVideoDiv.textContent = 'URL encontrada: ' + url;
        window.videoUrlEncontrada = url;
      }
      return originalOpen.apply(this, [method, url, ...rest]);
    };
  </script>
</body>
</html>
